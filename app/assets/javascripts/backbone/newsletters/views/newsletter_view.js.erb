Newsletter.module('Views', function(Module, App, Backbone, Marionette, $, _) {
    Module.NewsletterView = Backbone.Marionette.CompositeView.extend({
        template: Module.templateDirname() + 'newsletter_view',
        tagName: 'div',
        childViewContainer: '[data-type=bloc]',
        childView: Module.BlocView,

        events: {
        },

        initialize: function initialize () {
            // We need this to make sure we don't render some of the blocs filepickers twice.
            this.initialRender = true;
        },

        // The templateHelpers function allows us to create helper methods that
        // can be called from our template.
        //
        // More information:
        // <http://git.io/xpMt>
        templateHelpers: function templateHelpers () {
            return {
                // Renders the bloc's template with the bloc's attributes.
                renderBlocs: function renderedBlocs (bloc) {
                    var content = '';

                    this.blocs.forEach(function(bloc) {
                        var path = Module.templateDirname() + 'bloc_' + bloc.get('type');

                        bloc.set('index', bloc.get('position') - 1);
                        content += JST[path](bloc.attributes);
                        bloc.unset('index', { silent: true });
                    });

                    return content;
                },
                formAction: Routes.pro_structure_newsletters_path(window.coursavenue.bootstrap.structure),
                csrfName: $('meta[name="csrf-param"]').attr('content'),
                csrfToken: $('meta[name="csrf-token"]').attr('content'),
            };
        },

        // TODO: Save newsletter title before update.
        // TODO: Ask for confirmation ("Changing layout will lose your current
        // blocs. Are you sure you want to continue ?").
        updateLayout: function updateLayout (data) {
            var model = data.model;

            // If the layout is already selected, do nothing.
            if (model.get('id') == this.model.get('layout_id')) {
                return ;
            }

            this.model.set('layout_id', model.get('id'));

            this.render();
        },

        // Replace the HTML elements with their rich version:
        // - Replacing a `textarea` by a CKeditor,
        // - Replacing a `remote_image_url` input by a filepicker button.
        onRender: function onRender () {
            var pickers = this.$el.find('[name$=\\[remote_image_url\\]]');

            CKEDITOR.replaceAll();
            if (!this.initialRender) {
                pickers.each(function(index, elem) {
                    filepicker.constructWidget(elem);
                });
            }

            if (this.initialRender) {
                this.initialRender = false;
            }
        },

    });
});

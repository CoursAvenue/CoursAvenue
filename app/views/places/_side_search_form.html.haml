.map-with-slider
  - if @places.blank?
    = gmaps( {markers: {data: [{lat: params[:lat], lng: params[:lng]}].to_json}, map_options: {maxZoom: 11, mapTypeControl: false}})
  - else
    = gmaps( {markers: {data: @json_place_addresses}, map_options: {maxZoom: 15, mapTypeControl: false}})
  .grid--full.map-slider-container
    %label.three-twelfths.grid__item.v-middle.bold> Rayon
    #radius-slider.slider.seven-twelfths.grid__item.v-middle>
      #radius-knob.slider--knob
        .slider--inner-knob
    %label.two-twelfths.grid__item.v-middle.text--right.bold
      %span#radius-label-value= params[:radius]
      km

.side-search-panel
  - cache "place_subjects_#{ENV["ETAG_VERSION_ID"]}" do
    //-------------------------------------------------------------------------------------------------------- Subject
    .search-panel
      %h5.search-panel-header.toggleable-header{data: {behavior: 'toggleable', el:'+ .search-panel-content'}}
        Disciplines
        %i.icon-caret-down
      .search-panel-content
        %ul.check-list
          %li= link_to t('all_subject'), places_path(lat: params[:lat], lng: params[:lng]), class: 'subject-link'
          / ----------------- If the current subject is this one or has this one as a parent
          - Subject.roots.order(:name).each do |subject|
            - if params[:subject_id] == subject.slug || !subject.children.select{|d| d.id == params[:subject_id]}.blank?
              %li= link_to subject.name, subject_places_path(subject, lat: params[:lat], lng: params[:lng]), class: 'selected subject-link'
              %ul.check-list
                - subject.children.order('name ASC').each do |child_subject|
                  %li= link_to child_subject.name, subject_places_path(child_subject, lat: params[:lat], lng: params[:lng]), class: (params[:subject_id] == child_subject.slug ? 'selected subject-link' : 'subject-link')
            - else
              %li= link_to subject.name, subject_places_path(subject, lat: params[:lat], lng: params[:lng]), class: 'subject-link'

//-------------------------------------------------------------------------------------------------------- Gmaps
- content_for :scripts do
  :javascript
    window.addEvent('domready', function() {
        Gmaps.map.callback = function() {
            for (var i = 0; i <  this.markers.length; ++i) {
                google.maps.event.addListener(Gmaps.map.markers[i].serviceObject, 'click', function() {
                    var course_element = $$('.course-element[data-place-id=' + this.id + ']');
                    GLOBAL.Scroller.toElement(course_element[0]);
                    // Unselect courses if there already are that are selected
                    $$('.course-element').removeClass('selected');
                    course_element.addClass('selected');
                }.bind(Gmaps.map.markers[i]));
            }
        };
        var radius_hidden_input = $('radius-hidden-input');
        var radius_label_value  = $('radius-label-value');
        var start = 0;
        new Slider('radius-slider', 'radius-knob', {
            range: [1, 50],
            step: 1,
            wheel: false,
            snap: true,
            initialStep: #{params[:radius]},
            onComplete: function(pos){
                start += 1;
                if (start > 2) { // Because the function is triggered twice at beginning...
                    $('header-search').submit();
                }
            },
            onChange: function(pos){
                radius_hidden_input.set('value', pos);
                radius_label_value.set('text', pos);
            }
        });

    });

- if @place.image or @structure.image
  = content_for :meta_image do
    - if @place.image
      = @place.image.url
    - elsif @structure.image
      = @structure.image.url


= content_for :title do
  = @place.long_name

= content_for :meta_description do
  - if @structure.description.present?
    = @structure.description
  - else
    - if @place.parent_subjects_string.present?
      = "Retrouvez tous les cours et stages de #{@place.name} à #{@city.name}. #{subjects_name_from_string(@place.parent_subjects_string)} et bien plus !"
    - else
      = "Retrouvez tous les cours et stages de #{@place.name} à #{@city.name}."

- if cookies[:place_search_path]
  = link_to cookies[:place_search_path] do
    %i.orange ←
    Retour aux résultats
- else
  = link_to places_path(city: @city.name) do
    %i.orange ←
    Voir les établissements à proximité

%h1.course-title
  %span= @place.long_name
- if @place.rating
  %div
    %span.rating{title: comment_rating_title(@place.rating)}
      = rating_stars @place.rating
    (
    %span= @comments.count
    %a{href: '#comments'}
      %i.lbc-brand-icon
    )
%ul.nav.flush--bottom= join_place_parent_subjects @place, true

.grid--full.cf
  - # To Float left to have it first on mobile
  %section#summary.grid__item.three-tenths.lap--one-whole.palm--one-whole.float--right.islet>
    %article.course-info{itemscope: true, itemtype: 'http://schema.org/Place'}
      .visuallyhidden{itemprop: 'geo', itemscope: true, itemtype: 'http://schema.org/GeoCoordinates'}
        %meta{itemprop: 'latitude', content: @place.latitude}
        %meta{itemprop: 'longitude', content: @place.longitude}

      - if @place.thumb_image.present?
        .text--center= image_tag @place.thumb_image.url(:thumb)
      - elsif @place.structure.image.present?
        .text--center= image_tag @place.structure.image.url(:thumb)
      %h2.delta.text--center Contacter : #{@place.long_name}
      %hr
      - if @structure.website
        %div
          %i.icon-external-link.orange
          = link_to @structure.website, @structure.website, target: '_blank', rel: 'nofollow'
      .blue
        - if @place.contact_phone or @place.contact_mobile_phone
          %i.icon-phone.blue
        - if @place.contact_phone
          = link_to "tel:#{@place.contact_phone.gsub(/\s+/, '')}", class: 'blue' do
            = @place.contact_phone.gsub(' ', '&nbsp;').html_safe
        - if @place.contact_phone and @place.contact_mobile_phone
          %span.blue /
        - if @place.contact_mobile_phone
          = link_to "tel:#{@place.contact_mobile_phone.gsub(/\s+/, '')}", class: 'blue' do
            = @place.contact_mobile_phone.gsub(' ', '&nbsp;').html_safe
      %div
        %i.icon-home
        = readable_address @place

      .text--center.push--top
        - if current_user
          - if current_user.places.exists? @place.id
            = link_to "Enlever des favoris", remove_user_place_path(@place), class: 'btn btn__success one-whole disabled', method: :put, onclick: "_gaq.push(['_trackEvent', 'Établissement - enlever des favoris', 'click','Inscrit'])"
          - else
            = link_to 'Ajouter à mes favoris', add_user_place_path(@place), class: 'btn btn__success one-whole', method: :put, onclick: "_gaq.push(['_trackEvent', 'Établissement - ajouter aux favoris', 'click','Inscrit'])"
        - else
          %a.btn.btn__success.one-whole{href: '#', onclick: "_gaq.push(['_trackEvent', 'Établissement - ajouter aux favoris', 'click','Non inscrit'])",  data: {behavior: 'modal', title: 'Connectez-vous pour assister à ce cours', width: '400px', url: '/users/sign_up'}} Ajouter à mes favoris

    .text--center.white-box.islet
      - if @place.rating
        .delta Note : #{@place.rating}
        %div.gamma.push-half--bottom.push-half--top{itemprop: 'aggregateRating', itemscope: true, itemtype: 'http://data-vocabulary.org/review-aggregate'}
          %span.rating{title: comment_rating_title(@place.rating)}
            = rating_stars @place.rating
          %meta{property: 'v:rating', itemprop: 'rating', content: @place.rating}
          %meta{itemprop: 'count', content: @comments.count}
          %meta{itemprop: 'itemreviewed', content: @place.long_name}
          %meta{itemprop: 'name', content: @place.long_name}
          %meta{itemprop: 'street-address', content: @place.street}
          %meta{itemprop: 'postal-code', content: @place.zip_code}
          %meta{itemprop: 'locality', content: @city.name}

      - else
        .delta.push--bottom Aucun avis
      %div
        = link_to 'Donner mon avis', '#comments', class: 'btn btn__primary', onclick: "_gaq.push(['_trackEvent', 'Donner mon avis - lieu', 'click','#{@place.slug}'])"

    %hr

    %article.visuallyhidden--palm.visuallyhidden--lap
      .delta Établissements à proximité
      %ul.block-list
        - @surrounding_places.each do |surrounding_place|
          %li
            = link_to place_path(surrounding_place), class: 'flexbox similar-course--image-wrapper', onclick: "_gaq.push(['_trackEvent', 'Établissements à proximité - lieu', 'click','#{surrounding_place.slug}'])" do
              .flexbox__item.one-fifth.similar-course--image
                - if surrounding_place.image.present?
                  = image_tag surrounding_place.image.url(:thumb)
                - elsif (surrounding_place_subject = surrounding_place.subjects.limit(1)).any?
                  = image_tag surrounding_place_subject[0].image.url(:thumb)
              .flexbox__item.similar-course
                %h4.similar-course--course-name= surrounding_place.long_name
                .similar-course--structure-name
                  %i.icon-map-marker
                  = surrounding_place.street

  %section.grid__item.seven-tenths.palm--one-whole.lap--one-whole.islet>
    - if @place.image.present?
      .grid--full.course-header-badge>
        .grid__item.one-half.palm--one-whole>
          = image_tag @place.image.url(:wide), class: 'course-header-badge-image', alt: @place.long_name
        .grid__item.course-header-map.one-half.palm--one-whole>
          = gmaps( {markers: {data: @json_place_address}, map_options: {maxZoom: 15, mapTypeControl: false}} )
    - else
      .course-header-map
        = gmaps( {markers: {data: @json_place_address}, map_options: {maxZoom: 15, mapTypeControl: false}} )
        %h4.course-header-structure-name.flush--bottom
          %b= @place.name
          %br
          %i.icon-map-marker
          = readable_address @place

    = render 'share_links'
    - if @place.description.present?
      %hr
      %h2.delta.text--center Description de #{@place.long_name}
      %p= @place.description.html_safe
    %hr
    - if @courses.length > 0
      %h2.delta.text--center <b>Cours</b> proposés par #{@place.long_name}
      #course-list{style: (@courses.length > 4 ? 'height: 20em; overflow: hidden' : '')}
        %table.table--striped
          %thead
            %tr
              %th.five-twelfths Nom du <b>cours</b>
              %th.three-twelfths.text--center Disciplines
              %th.two-twelfths.text--center Niveau
              %th.two-twelfths.text--center Nombres de séances
              %th
          %tbody
            - @courses.each do |course|
              %tr
                %td
                  %h3.base-font-style.flush--bottom= link_to course.name, course_path(course)
                  - if course.rating
                    = rating_stars course.rating
                %td.text--center
                  %ul.nav
                    = join_course_subjects course
                %td.text--center= course.levels.map{|level| t(level.name) }.join(', ')
                %td.text--center= course.plannings.count
                %td.text--right= link_to 'Assister', course_path(course), class: 'btn btn__success'
      - if @courses.length > 4
        .text--center.islet
          %a.btn#show-more-courses Voir tous les cours
      %hr
    %article#comments
      = render 'comments'

= content_for :scripts do
  :javascript
    window.addEvent('domready', function() {
        var is_hidden = true;
        $('show-more-courses').addEvent('click', function() {
            if (is_hidden) {
                $('course-list').setStyle('height', 'auto');
                this.set('text', 'Cacher les cours');
            } else {
                $('course-list').setStyle('height', '20em');
                this.set('text', 'Voir tous les cours');
            }
            is_hidden = !is_hidden;
            return false;
        });
    });

= side_menu_currently_at 'JPO'

= render partial: 'pro/open_courses/tabs', locals: { current: 'participations' }

.text--center
  .inline-block.one-quarter.push--bottom.v-middle.push--sides
    .white-box.soft-half.text--center
      %h3.flush= "#{Participation.not_canceled.count} inscriptions"
      %h6.flush dont #{Participation.not_canceled.where{created_at > Date.today}.count} aujourd'hui
      %div et #{Participation.not_canceled.where{created_at > Date.today - 7.days}.count} les 7 derniers jours

  .inline-block.one-quarter.push--bottom.v-middle.push--sides
    .white-box.soft-half.text--center
      %h3.flush= "#{Participation.canceled.count} annulation"
      %h6.flush dont #{Participation.canceled.where{created_at > Date.today}.count} aujourd'hui
      %div et #{Participation.canceled.where{created_at > Date.today - 7.days}.count} les 7 derniers jours

  .inline-block.one-quarter.push--bottom.v-middle.push--sides
    .white-box.soft-half.text--center
      %h3.flush
        = Course::Open.all.map{|course| course.nb_participants_max * course.plannings.count}.reduce(&:+)
        places

.white-box.islet.text--center
  #participations

%table.white-box.table--data.table--striped.table--white.push-half--top
  %thead
    %tr
      %th.two-twelfths Nom de l'élève
      %th.two-twelfths Email
      %th.two-twelfths Téléphone
      %th.one-twelfths Ville
      %th.two-twelfths Date d'inscription
      %th.two-twelfths Atelier
      %th.two-twelfths
  %tbody
    - @participations.each do |participation|
      %tr{class: (participation.canceled? ? 'red' : '')}
        %td
          = participation.user.name
          - if participation.with_kid?
            (+ 1 enfant)
        %td
          = link_to participation.user.email, "mailto:#{participation.user.email}", target: :_blank
        %td= readable_phone_number participation.user.phone_number
        %td= "#{participation.user.city.try(:name)} (#{participation.user.zip_code})"
        %td= l(participation.created_at, format: :date).capitalize
        %td
          = link_to participation.planning.course.name, pro_structure_course_opens_path(participation.structure)
          par
          = link_to participation.structure.name, pro_structure_course_opens_path(participation.structure), target: :_blank
        %td.text--center
          - if participation.waiting_list?
            Sur liste d'attente
          - if participation.canceled?
            Annulé

= content_for :scripts do
  :javascript
    $(function() {
        $('#dataTable').tablesorter();
        new Highcharts.Chart({
            chart: { renderTo: 'participations', type: 'spline' },
            title: { text: null },
            xAxis: { categories: #{@participations_graph.map{|date, count| l(Date.parse(date.to_s), format: :short)}} },
            yAxis: { title: { text: ''}},
            series: [{ data: #{@participations_graph.map{|date, count| count}} }]
        });
    });

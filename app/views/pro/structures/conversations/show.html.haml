= side_menu_currently_at 'messages'
- recipients = @conversation.recipients.reject{|recipient| recipient == @admin }
- participation_request = conversation_participation_request(@conversation)
.panel
  .panel__header.soft
    %ol.nav.flush.breadcrumb{ itemprop: 'breadcrumb' }
      %li.delta= link_to 'Boîte de réception', pro_structure_conversations_path(@structure)
      %li.delta Conversation avec #{truncate(recipients.map{|recipient| recipient.name || recipient.email}.join(', '), length: 50) }
  .panel__body.soft
    .grid
      .grid__item.two-twelfths.v-middle.text--right>
        %p.flush Objet
      .grid__item.ten-twelfths.soft-half--left.v-middle>
        %h5.flush
          = @conversation.subject
          - if conversation_extra_infos(@conversation).present?
            = "(#{conversation_extra_infos(@conversation).map{ |extra_info| t("#{extra_info.name}_small") }.join(', ')})"
    .grid
      .grid__item.two-twelfths.v-middle.text--right>
        %p.flush À
      .grid__item.ten-twelfths.soft-half--left.v-middle>
        %h5.flush= recipients.map(&:name).join(', ')

    - user = @conversation.recipients.detect{ |recipient| recipient.is_a? User }
    - if user.phone_number.present?
      - # If it is a request, show phone number only if request is accepted
      .grid.epsilon.push-half--bottom
        .grid__item.two-twelfths.v-middle.text--right.v-middle>
          %strong.flush
            Téléphone
        .grid__item.ten-twelfths.soft-half--left.v-middle>
          - if !participation_request or (participation_request and participation_request.accepted?)
            %strong= readable_phone_number user.phone_number
          - else
            %i Le téléphone de l'élève s'affichera une fois l'inscription confirmée
    - if conversation_courses(@conversation, @structure).present?
      .grid
        .grid__item.two-twelfths.v-middle.text--right>
          %strong.flush= "Cours concerné".pluralize(conversation_courses(@conversation, @structure).length)
        .grid__item.ten-twelfths.soft-half--left.v-middle>
          = conversation_courses(@conversation, @structure).map(&:name).join(', ')

    - if @participation_request
      .grid.push-half--top
        .grid__item.two-twelfths.v-middle.text--right>
        .grid__item.ten-twelfths.soft-half--left.v-middle>
          .flexbox
            .flexbox__item.v-middle{ class: (@participation_request.pending? ? 'one-whole' : 'three-quarters') }>
              .soft-half.white{ class: "#{participation_request_color(@participation_request)}-box" }
                .flexbox
                  .flexbox__item.delta.v-middle.soft-half--right{ style: 'width: 1em;' }>
                    = participation_request_icon(@participation_request)
                  .flexbox__items.epsilon.v-middle.one-whole>
                    = participation_request_long_description(@participation_request, 'structure')
            - if @participation_request.accepted? or (@participation_request.pending? and @participation_request.last_modified_by == 'Structure')
              .flexbox__item.v-middle.one-quarter.soft-half--left#modify-links>
                = link_to 'Proposer un autre créneau', edit_pro_structure_participation_request_path(@structure, @participation_request), class: 'orange nowrap fancybox.ajax', data: { behavior: 'modal', width: 800, padding: 0 }
                %br
                = link_to "Annuler l'inscription", cancel_form_pro_structure_participation_request_path(@structure, @participation_request), class: 'red nowrap fancybox.ajax', data: { behavior: 'modal', width: 800, padding: 0 }

      .grid.epsilon.push--top
        .grid__item.two-twelfths.v-top.text--right>
          %strong.flush
            Récapitulatif
          .milli.blue Infos transmises à l'élève
        .grid__item.ten-twelfths.soft-half--left.v-top>
          %ul.no-bullet-list.flush
            %li
              %strong Nom du cours :
              = @participation_request.course.name
            %li
              %strong Jour et créneau :
              #{l(@participation_request.date, format: :semi_long)} : #{l(@participation_request.start_time, format: :short)} à #{l(@participation_request.end_time, format: :short)}.
            - if @participation_request.place
              %li
                %strong Lieu :
                = @participation_request.place.name
              %li
                %strong Infos pratiques :
                %br
                = @participation_request.place.info
                - if @participation_request.place.private_info.present?
                  %br
                  = @participation_request.place.private_info
                %br
                = link_to edit_pro_structure_place_path(@structure, @participation_request.place, return_to_action: 'window.location.reload()'), class: 'milli fancybox.ajax', data: { behavior: 'modal', width: '650', padding: 0 } do
                  %i.fa.fa-pencil
                  Modifier les infos pratiques

      .push--top
        - if @participation_request.pending? and @participation_request.last_modified_by == 'User'
          = render 'pro/structures/conversations/participation_request_form'
        - else
          = render 'pro/structures/conversations/form'
    - else
      .push--top= render 'pro/structures/conversations/form'

    = render partial: 'messages/message', collection: @conversation.messages.order('created_at DESC').reject(&:new_record?)

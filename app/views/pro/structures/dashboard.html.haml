= side_menu_currently_at 'Tableau de bord'
.white-box.soft--top
  - if @wizard
    #wizard.blue-box.islet.hidden.relative
      %a#close-wizard.closer{href: 'javascript:void(0)', data: { behavior: 'closer', el: '#wizard'}}
        %i.fa.fa-times
      #wizard-form= render @wizard.partial
      - if @wizard.show_save
        %span.btn.btn--green#save-wizard Enregistrer
      %a#skip-wizard.soft-half--left{href: 'javascript:void(0)'} Passer
    = render 'pro/structures/wizards/share_your_profile'

  .soft--sides
    .grid
      .grid__item.one-half.bordered--right>
        %h4.push-half--bottom Votre profil est complété à #{@profile_percentage}%
        .text--center.progress.push-half--bottom{style: "width: 280px;"}
          - if @profile_percentage == 0
            #{@profile_percentage}%
          - else
            #profile-progress-bar.bar.bar-success{style: "width: 0%;"}
              #{@profile_percentage}%
        %ul.no-bullet-list
          %li
            %i.fa.fa-check-square-o
            %span.line-through--gray Créer mon profil
          %li
            - if @structure.profile_completed?
              %i.fa.fa-check-square-o
              %span.line-through--gray Compléter mes informations générales et ajouter un logo
            - else
              = link_to edit_pro_structure_path(@structure), class: 'profile-task-uncomplete' do
                %i.fa.fa-square-o
                Compléter mes informations générales et ajouter un logo
          %li
            - if @comments.any?
              %i.fa.fa-check-square-o
              %span.line-through--gray Demander des recommandations à mes élèves
            - else
              = link_to recommendations_pro_structure_path(@structure), class: 'profile-task-uncomplete' do
                %i.fa.fa-square-o
                Demander des recommandations à mes élèves
          %li
            - if @structure.medias.any?
              %i.fa.fa-check-square-o
              %span.line-through--gray Mettre en ligne les photos et vidéos de mes cours
            - else
              = link_to pro_structure_medias_path(@structure), class: 'profile-task-uncomplete' do
                %i.fa.fa-square-o
                Mettre en ligne les photos et vidéos de mes cours
          %li
            - if @structure.courses.without_open_courses.active.count > 0
              %i.fa.fa-check-square-o
              %span.line-through--gray Renseigner mes cours et mon planning
            - else
              = link_to pro_structure_courses_path(@structure), class: 'profile-task-uncomplete' do
                %i.fa.fa-square-o
                Renseigner mes cours et mon planning
      .grid__item.one-half>
        .soft--right
          %h4.push-half--bottom Vos recommandations et récompenses
          %table#progress-comments.push-half--right.flush--bottom
            %tbody
              %tr{style: 'background: #e7e1da;'}
                - @structure.comments.accepted.limit(15).order('created_at ASC').each do |comment|
                  %td.text--center.hard{style: "width: 6.6%;"}
                    .hidden.bg-green{ data: { toggle: 'popover', html: 'true', placement: 'bottom', content: "<div style='font-size: 12px;'>#{comment.author_name} le #{I18n.l(comment.created_at, format: :date)}<br><br>#{comment.content.html_safe}<div>", trigger: 'hover' } }
                      %a{href: 'javascript:void(0)'}
                        %i.fa.fa-comment.white
                - if @structure.comments.accepted.count < 15
                  - (15 -@structure.comments.accepted.count).times do |index|
                    %td.text--center.hard{style: "width: 6.6%;"}
                      &nbsp;
          %table.push-half--right
            %thead
              %tr
                - 15.times do |index|
                  %th.text--center.hard{style: "width: 6.6%;"}

            %tbody
              %tr
                %td.v-top.text--center.hard{colspan: 9}
                  %i.fa.fa-arrow-up
                  %br
                  %span.nowrap À partir du 5<sup>e</sup> avis :
                  %br
                  - if @structure.comments_count > 4
                    = link_to widget_pro_structure_path(@structure), class: 'btn btn--blue nowrap text--center' do
                      Installer mon
                      %br
                      livre d'or
                  - else
                    %a.btn.text--center{href: '#livre-dor-explanation', data: {behavior: 'modal'}} OBTENEZ VOTRE LIVRE D'OR
                %td.text--right.v-top.hard{colspan: 6}
                  %i.fa.fa-arrow-up
                  %br
                  %span.nowrap À partir de 15 avis et +
                  %br
                  - if @structure.comments_count > 14
                    = link_to new_pro_structure_sticker_demand_path(@structure), class: 'btn btn--blue text--center nowrap' do
                      Recevoir mes
                      %br
                      autocollants
                  - else
                    %a.btn.text--center{href: '#sticker-explanation', data: {behavior: 'modal'}} OBTENEZ VOS AUTOCOLLANTS

  #livre-dor-explanation.hidden
    %h3.text--center Vous n'avez pas encore accès à votre livre d'or

    %p
      %strong Au-delà de 5 avis, nous vous offrons votre livre d'or interactif
      qui vous permet d'afficher toutes les recommandations de vos élèves directement sur votre propre site Internet ou blog, mais aussi sur tous les autres supports de communication (flyers, affiches, signature de vos emails, etc.).
    %p
      Le bouche à oreille restant le 1er facteur d'inscription à un cours, nos partenaires qui affichent publiquement les témoignages de leurs élèves sont ceux qui ont le plus fort taux d'inscription et de fidélisation.
    .text--center.push--bottom= link_to "Exemples de livres d'Or.", pro_pages_widget_path, target: '_blank', rel: 'nofollow'
    %p.text--center
      = link_to "Obtenir plus d'avis", recommendations_pro_structure_path(@structure), class: 'btn btn--blue'

  #sticker-explanation.hidden
    %h3.text--center Vous n'avez pas encore accès à votre autocollant
    %p
      %strong Au-delà de 15 avis, nous vous offrons l'autocollant "Recommandé par les élèves sur CoursAvenue"
      à afficher sur vos lieux de cours : cela signifie que vos cours sont appréciés d'une large partie de vos élèves et que le bouche à oreille participe à votre développement.

    %p.text--center
      = link_to "Obtenir plus d'avis", recommendations_pro_structure_path(@structure), class: 'btn btn--blue'


  %hr.push--ends
  .soft--sides
    %h4.push-half--bottom Résumé du profil
    = render 'pro/structures/structure'

  %hr.push--ends
  .soft--sides
    .grid
      .grid__item.one-third>
        .islet.text--center
          %h4.flush
            %i.fa.fa-comments
            Avis
          %p
            %span.beta{class: (@comments.length > 6 ? 'green' : 'red')}= @comments.length
            %br
            = link_to "Obtenir plus d'avis", recommendations_pro_structure_path(@structure), class: 'btn btn--blue btn--small', onclick: "ga('send', 'event', 'Dashboard', 'click', 'Demander des recommandations')"

      .grid__item.one-third>
        .islet.text--center
          %h4.flush
            %i.fa.fa-list
            Cours en ligne
          %p
            %span.beta{class: (@structure.courses.active.count > 2 ? 'green' : 'red')}= @structure.courses.active.count
            %br
            = link_to 'Ajouter des cours', pro_structure_courses_path(@structure), onclick: "ga('send', 'event', 'Dashboard', 'click', 'Ajouter des cours')", class: 'btn btn--blue btn--small'
      .grid__item.one-third>
        .islet.text--center
          %h4.flush
            %i.fa.fa-youtube-play
            Photo & vidéos
          %p
            %span.beta{class: (@structure.medias.count > 3 ? 'green' : 'red')}= @structure.medias.count
            %br
            = link_to 'Ajouter des photos / vidéos', pro_structure_medias_path(@structure), onclick: "ga('send', 'event', 'Dashboard', 'click', 'Ajouter des medias')", class: 'btn btn--blue btn--small'

  %hr.push--ends
  .soft--sides
    %h4
      %i.fa.fa-map-marker
      Mes lieux d'enseignement

    #map.google-map
    .text--center
      = link_to "Ajouter un lieu d'enseignement", pro_structure_places_path(@structure), class: 'btn btn--blue push-half--ends'

  - if @comments.length > 0
    %hr.push--ends
    .soft--sides
      %h4
        %i.fa.fa-comments
        Mes derniers avis
      %ul.comment-list
        = render partial: 'comments/comment', collection: @comments[0..2]
        - if @comments.length > 3
          %p.text--center= link_to 'Voir mes autres avis', pro_structure_comments_path(@structure)

  - if @courses.any?
    %hr.push--ends
    .soft--sides
      %h4 Mes cours
      %table.table--striped
        %thead
          %tr
            %th.text--center.one-twelfth Statut
            %th.five-twelfths Nom du <b>cours</b>
            %th.three-twelfths.text--center Disciplines
            %th.two-twelfths.text--center Séances à venir
            %th.text--right Prix
        %tbody
          - @courses.each do |course|
            %tr
              %td.text--center
                - if course.active
                  = link_to disable_pro_structure_course_path(@structure, course), method: :patch, class: 'switch-button on', title: 'Enlever le cours de CoursAvenue' do
                    Visible
                - else
                  = link_to activate_pro_structure_course_path(@structure, course), method: :patch, class: 'switch-button off', title: 'Afficher le cours sur CoursAvenue'  do
                    Non&nbsp;visible
              %td
                %h3.base-font-style.flush--bottom= link_to course.name.capitalize, edit_pro_structure_course_path(@structure, course)
              %td.text--center
                %ul.nav.flush--bottom
                  = join_course_subjects course
              %td.text--center= course.plannings.future.count
              %td.text--right
                - if course.best_price
                  = "#{readable_amount course.best_price.amount}€".html_safe
      %p.text--center= link_to 'Ajouter un cours', pro_structure_courses_path(@structure), class: 'btn btn--blue'

  - if @medias.any?
    %hr.push--ends
    .soft--sides
      %h4 Mes photos & vidéos
      .media-gallery
        - @medias.each do |media|
          .one-third.media__item.very-soft.show-on-hover-wrapper>
            %a.break-all.soft-half.hard--bottom.block{href: media.url, title: media.caption, data: {behavior: 'fancy'}}
              %i.fa.fa-expand
              = media.thumbnail_url_html
              - if media.caption.present?
                %p.flush--bottom
                  %i= media.caption
            - if media.image? and !media.cover?
              = link_to 'Définir comme photo de profil', make_it_cover_pro_structure_image_path(@structure, media), method: :put, class: 'push-half--left show-on-hover btn btn--small btn--blue'
            = link_to 'Supprimer', pro_structure_media_path(@structure, media), method: :delete, data: { confirm: 'Êtes-vous sûr de vouloir supprimer ce média ?' }, class: 'push-half--left show-on-hover btn btn--small btn--red'

      %p.text--center= link_to 'Ajouter une photo ou une vidéo', pro_structure_medias_path(@structure), class: 'btn btn--blue'

= content_for :scripts do
  :javascript
    $(function() {
        $('#progress-comments .hidden').each(function(index, td) {
            setTimeout(function(){
              $(td).removeClass('hidden');
              var width = $(td).css('width');
              $(td).css('width', '0');
              $(td).animate({width: width}, 250, 'linear');
            }, index * 250)
        });
        $('a.profile-task-uncomplete').hover(function() {
            $(this).find('i').removeClass('fa fa-square-o').addClass('fa fa-check-square-o');
        }, function() {
            $(this).find('i').removeClass('fa fa-check-square-o').addClass('fa fa-square-o');
        });
        $('#profile-progress-bar').animate({
            width: '#{@profile_percentage}%'
        }, 800);
        setTimeout(function() {
            if ($('#wizard').length > 0) {
                $('#wizard').slideDown();
                var send_ajax = function(options) {
                    options = options || '';
                    $.ajax({
                        url: "#{wizard_pro_structure_path(@structure, format: :json)}",
                        dataType: 'json',
                        data: options,
                        success: function(response) {
                            $('#wizard-form').hide('slow');
                            setTimeout(function(){
                                if (response.done) {
                                    $('#wizard').hide('slow');
                                    $('#share_your_profile').show('slow');
                                } else {
                                    $('#wizard-form').html(response.form);
                                    $('#wizard-form').show('slow');
                                }
                            }, 500);
                        }
                    })
                }
                var submit_form = function() {
                    $('#wizard form').submit().bind('ajax:success', function() {
                        if ($('#wizard form input[name=next]').length > 0) {
                            send_ajax({next:true});
                        } else {
                            send_ajax()
                        }
                    });
                    return false;
                };
                $('#save-wizard').click(submit_form);
                $('#skip-wizard').click(function(){
                    var wizard_label = $('#wizard form label').text();
                    send_ajax({next:true});
                });
                $('#close-wizard').click(function() {
                });
            }
        }, 1000);
        google_map_handler = Gmaps.build('Google', { markers: { maxRandomDistance: null } });
        google_map_handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
            markers = google_map_handler.addMarkers(#{@json_locations.to_json});
            google_map_handler.bounds.extendWith(markers);
            google_map_handler.fitMapToBounds();
            if (google_map_handler.getMap().getZoom() > 15) {
              google_map_handler.getMap().setZoom(15);
            }
        });
    });

- participation_request_decorator = @participation_request.decorate

- if current_pro_admin
  = side_menu_currently_at 'inscriptions'

- user           = @participation_request.user
- user_decorator = user.decorate
- first_message = @participation_request.conversation.messages.order('created_at DESC').reject(&:new_record?).first
%h3.palm-text--center Demande d'inscription de #{@user.name}
.grid--full.push--bottom.message
  .grid__item.palm-one-whole.palm-block.palm-text--center.two-twelfths.v-top.v-top>
    - if user.has_avatar?
      = image_tag user.avatar_url(:normal), class: 'center-block push-half--bottom rounded--circle', width: 100
      .text--center
        = "#{l(local_time(first_message.created_at).to_date, format: :short)} à #{l(local_time(first_message.created_at), format: :short)}"
  .grid__item.palm-one-whole.palm-block.palm-text--center.ten-twelfths.v-top>
    .delta.line-height-1-7.flush
      = user_decorator.age_and_city
    - if user.description.present?
      %div.line-height-1-7.quoted.epsilon.push-half--bottom
        %i= user.description
    .message__body.soft-half.gray-box.message__appendix
      .epsilon.line-height-1-5
        = "#{@participation_request.course.name}, le "
        %strong= "#{participation_request_decorator.day_and_hour},"
        = participation_request_decorator.details
      %hr.push-half--ends
      = simple_format first_message.body

    -# - if user.phone_number.present?
    -#   %div.line-height-1-7
    -#     Téléphone :
    -#     %span{ class: (@participation_request.show_personnal_info? ? '' : 'has-tooltip' ), data: { toggle: (@participation_request.show_personnal_info? ? '' : 'popover'), content: t('tooltips.pro.participation_requests.infos_will_be_shown_once_accepted'), html: 'true', placement: 'top', trigger: 'hover' } }
    -#       = user_decorator.phone_number(!@participation_request.show_personnal_info?)
    -# %div.line-height-1-7
    -#   Email :
    -#   %span{ class: (@participation_request.show_personnal_info? ? '' : 'has-tooltip' ), data: { toggle: (@participation_request.show_personnal_info? ? '' : 'popover'), content: t('tooltips.pro.participation_requests.infos_will_be_shown_once_accepted'), html: 'true', placement: 'top', trigger: 'hover' } }
    -#     = user_decorator.email(!@participation_request.show_personnal_info?)

.flexbox.push--bottom
  .flexbox__item.five-twelfths.v-middle.nowrap>
    %h3.flush Répondez-lui au plus vite :
  - if @participation_request.pending? and @participation_request.last_modified_by == 'User' and !@participation_request.past?
    .flexbox__item.two-twelfths.v-middle>
      = link_to accept_form_pro_structure_participation_request_path(@participation_request.structure, @participation_request), class: 'btn--full nowrap palm-flush push-half--right soft--sides btn--green btn fancybox.ajax', data: { behavior: 'modal', width: 500, padding: 0 } do
        = t('.accept')
  .flexbox__item.two-twelfths.v-middle.soft-half--left>
    .btn.btn--full.nowrap Envoyer un message
  .flexbox__item.three-twelfths.v-middle.soft-half--left>
    .btn.btn--full.nowrap Voir ses coordonnées


-# Because this page can be accesed throught bitly as non connected user.
- if current_pro_admin
  = content_for :top_menu do
    .flexbox
      .flexbox__item.v-middle
        %ol.nav.flush.breadcrumb{ itemprop: 'breadcrumb' }
          %li.active-without-caret= link_to 'Mes inscriptions', pro_structure_participation_requests_path(@structure), class: 'semi-muted-link epsilon f-weight-600 soft--left soft-half--ends white'
          %li.epsilon.f-weight-500.white.soft-half--ends= @user.name
      - if !@participation_request.from_personal_website?
        - if @participation_request.pending? and @participation_request.last_modified_by == 'User' and @participation_request.created_at > 2.days.ago
          .flexbox__item.v-middle.text--right.white.soft--right
            %i.fa-clock-o.epsilon
            %strong.epsilon Expire dans
            %strong.epsilon{ data: { 'expires-in' => true } }
- else
  %h1.palm-text--center Demande d'inscription de #{@user.name}
.push--bottom
  = render partial: 'pro/structures/participation_requests/table_recap', locals: { participation_request: @participation_request }

- if !@participation_request.pending?
  = render partial: 'pro/structures/conversations/form', locals: { conversation: @participation_request.conversation }
- if @participation_request.conversation.messages.order('created_at DESC').reject(&:new_record?).length > 1
  = render partial: 'messages/message', collection: @participation_request.conversation.messages.order('created_at DESC').reject(&:new_record?)

= content_for :scripts do
  :javascript
    $(function() {
      var date            = Date.parse("#{l(local_time(@participation_request.created_at + 48.hours), format: :js )}");
      var $countdown_div = $('[data-expires-in]');
      countdown(date,
          function(ts) {
              var hours   = ("0" + ts.hours).slice(-2);
              var minutes = ("0" + ts.minutes).slice(-2);
              var seconds = ("0" + ts.seconds).slice(-2);
              $countdown_div.text((ts.days > 0 ? ts.days + ' jour et ' : '') + hours + ':' + minutes + ':' + seconds);
          },
          countdown.DAYS|countdown.HOURS|countdown.MINUTES|countdown.SECONDS);
    });


- if @structure.logo.present?
  = content_for :meta_image do
    = @structure.logo.url(:thumb)

= content_for :title do
  = "#{@structure.name} à #{@city.name}"

= content_for :meta_description do
  - if @structure.description.present?
    = "#{@structure.description_for_meta} à #{@city.name}"
  - else
    - if @structure.parent_subjects_string.present?
      = "Retrouvez tous les cours de #{@structure.name} à #{@city.name}. #{subjects_name_from_string(@structure.parent_subjects_string)} et bien plus ! à #{@city.name}"
    - else
      = "Retrouvez tous les cours de #{@structure.name} à #{@city.name}"

.visuallyhidden#lieux-photos
  .inline-block
    - if cookies[:structure_search_path]
      = link_to cookies[:structure_search_path] do
        %i.orange ←
        = t('.back_to_results')
    - else
      = link_to structures_path do
        %i.orange ←
        = t('.see_arrounding_structures')
  .inline-block.push-half--sides
    |
  .inline-block.push-half--bottom
    %ol.nav.breadcrumb.flush{itemprop: 'breadcrumb'}
      %li
        = link_to "Tous les établissement", structures_path
      %li= @structure.name

- if !current_user and params[:waiting_for_activation]
  .blue-box.islet.text--center.push--ends
    = render 'users/waiting_for_activation_text'

%div{ itemscope: true, itemtype: "http://schema.org/LocalBusiness" }
  = render partial: 'structures/structure_header', locals: { structure: @structure }
  .soft--sides
    .grid
      .grid__item.eight-twelfths.soft-half--right>
        = render partial: 'structures/map_and_gallery', locals: { medias: @medias }

        #structure-profile{ data: { type: 'structure-profile-root' } }
          - if @is_sleeping
            = render partial: 'structures/sleeping_content', locals: { medias: @medias }
          - else
            #structure-region
          %div{ data: { type: "comments-collection" } }
      .grid__item.four-twelfths>
        = render partial: 'structures/contact_form', locals: { structure: @structure }
        - unless @is_sleeping
          .panel.push--bottom
            - if @structure.response_rate or @structure.response_time or (@structure.main_contact and @structure.main_contact.current_sign_in_at)
              .panel__body.soft.epsilon
                - if @structure.response_rate
                  .grid--full.soft-half--bottom
                    .grid__item.v-middle.one-half.gray>
                      Taux de réponse
                    .grid__item.v-middle.one-half>
                      %strong= "#{@structure.response_rate}%"
                - if @structure.response_time
                  .grid--full.soft-half--bottom
                    .grid__item.v-middle.one-half.gray>
                      Temps de réponse
                    .grid__item.v-middle.one-half>
                      %strong= response_time_in_words @structure
                - if @structure.main_contact and @structure.main_contact.current_sign_in_at
                  .grid--full
                    .grid__item.v-middle.one-half.gray>
                      Dernière activité
                    .grid__item.v-middle.one-half>
                      %strong= l(@structure.main_contact.current_sign_in_at, format: :date).capitalize

          .panel.push--bottom
            .panel__header.soft-half--ends.soft--sides
              %h5.flush Actualités et offres exclusives
            .panel__body.soft
              - if current_user and current_user.follows?(@structure)
                = link_to '#', class: "btn btn--full disabled" do
                  %i.fa.fa-heart
                  Déjà en favori
              - elsif current_user
                = link_to follow_structure_path(@structure), method: :post, class: "btn btn--full btn--gray", data: { toggle: 'tooltip', placement: 'left', title: "Ajoutez ce profil en favori pour suivre son actualité et recevoir des offres exclusives (cours d'essai gratuits, promotions, invitations, etc.)." } do
                  %i.fa.fa-heart
                  Favori
              - else
                = link_to new_user_registration_path, data: { behavior: 'modal', title: 'Connexion', width: 600, padding: 0, toggle: 'tooltip', placement: 'left', title: "Ajoutez ce profil en favori pour suivre son actualité et recevoir des offres exclusives (cours d'essai gratuits, promotions, invitations, etc.)." }, class: 'fancybox.ajax btn btn--full btn--gray', onclick: "ga('send', 'event', 'Se créer un compte', 'click','Inscrit')" do
                  %i.fa.fa-heart
                  Favori
              - if @structure.followers.count > 9
                %p.flush.text--center.push-half--top
                  %strong Suivi par #{@structure.followers.count} élèves

        - # This additionnal div is necessary for the husk that will be prepended
        - # to the parent of the sticky div
        %div
          %div{ data: { type: (@is_sleeping ? '' : 'sticky-map-container') }}>
            - unless @is_sleeping
              .push--bottom{ data: { type: (@is_sleeping ? '' : 'sticky-map') }}>
              %a.push--bottom.contact-button.btn--full.btn.btn--green{ data: { behavior: 'show-contact-panel' } }
                Contacter
                = I18n.t("structures.structure_type_contact.#{(@structure.structure_type.present? ? @structure.structure_type : 'structures.other')}")

            - unless @structure.premium?
              .panel.push--bottom
                .panel__header.soft-half--ends.soft--sides
                  %h5.flush Profils similaires
                .panel__body.soft-half--ends{ style: (@is_sleeping ? '' : 'height: 250px; overflow: scroll;') }
                  - @structure.similar_profiles(14).each_with_index do |structure, index|
                    - unless index == 0
                      %hr.push-half--ends
                    %div{ style: 'height: 70px;' }
                      = link_to structure_path(structure), class: 'soft-half--sides block muted-link' do
                        .grid--full{ data: { similar_profile: true, structure_id: structure.id } }
                          .grid__item.v-top.one-fifth>
                            .media-photo{ itemprop: 'image', content: structure.logo.url }= image_tag structure.logo.url(:thumb)
                          .grid__item.v-top.four-fifths.soft-half--left.opacity-hidden-on-hover__wrapper>
                            %div
                              - if structure.premium? and header_promotion_title_for_structure(structure).present?
                                %h6.inline-block.push-half--bottom= truncate(structure.name, length: 18)
                                .lbl.lbl--small.lbl--yellow
                                  %i.fa.fa-star
                                  = header_promotion_title_for_structure(structure)
                              - else
                                %h6.inline-block.push-half--bottom= truncate(structure.name, length: 30)
                            %div
                              %i= truncate(structure.places.map(&:city).uniq.map(&:name).join(', '), length: 40)
                            .btn.btn--small.btn--blue.btn--full.opacity-hidden-on-hover__child Voir le profil

= content_for :scripts do
  :javascript
    (function () {
      window.coursavenue = window.coursavenue || {};
      window.coursavenue.bootstrap = {
        current_pro_admin: #{(current_pro_admin ? true : false)},
        structure: #{ @model.to_json },
        meta: {
          total_comments: #{ @structure.comments.accepted.count },
          structure_id  : #{ @structure.id }
        }
      };
    }());

= user_menu_currently_at 'Mes messages'

- recipient = @conversation.recipients.reject{|recipient| recipient == @user }.first
%ol.nav.breadcrumb{itemprop: 'breadcrumb'}
  %li.delta= link_to 'Mes conversations', user_conversations_path(current_user)
  %li.delta Conversation avec #{recipient.name || recipient.email}

.grid
  .grid__item.one-twelfth.v-top.text--right>
    Objet
  .grid__item.eleven-twelfths.soft-half--left>
    %h5= @conversation.subject

= render partial: 'messages/message', collection: @conversation.messages.reject(&:new_record?).sort_by(&:created_at)

= render 'users/conversations/form'

- if !current_user and !@user.active?
  #registration.hidden
    %div
      = link_to "S'enregistrer avec Facebook", user_omniauth_authorize_path('facebook'), class: 'btn btn--facebook btn--full', id: 'facebook_button'
    .or
      %span ou
    = simple_form_for @user, url: first_update_user_path(@user) do |user_form|
      = user_form.error_notification
      %input#hidden-message{type: 'hidden', name: 'message'}
      %input{type: 'hidden', value: @user.email, name: 'previous_email'}
      %input{type: 'hidden', value: params[:token], name: 'reset_password_token'}
      = user_form.input :name, label: false, placeholder: 'Nom', input_html: {class: 'one-whole'}
      = user_form.input :email,    label: false, placeholder: 'Email', wrapper_html: {class: 'flush--top'}, input_html: {class: 'one-whole'}
      = user_form.input :password, label: false, placeholder: 'Mot de passe', input_html: {class: 'one-whole'}
      = user_form.button :submit, "Cr√©er son compte", class: 'btn--green one-whole'

  - content_for :scripts do
    :javascript
      $(function(){
          $('#registration-link').click(function(){
              $('#hidden-message').val($('[name="conversation[message][body]"]').val());
              $.removeCookie("conversation_#{params[:id]}_message_first_time");
              $.cookie('conversation_#{params[:id]}_message', $('[name="conversation[message][body]"]').val(), { expires: 7, path: '/' });
          });
          $('[data-behavior="connection"]').click(function() {
              $.fancybox($('#registration'));
          });
      });

- content_for :scripts do
  :javascript
    $(function(){
        if ($.cookie("conversation_#{params[:id]}_message_first_time")) {
            $.removeCookie("conversation_#{params[:id]}_message", {path: '/'});
        } else {
            $.cookie("conversation_#{params[:id]}_message_first_time", true);
        }
    });

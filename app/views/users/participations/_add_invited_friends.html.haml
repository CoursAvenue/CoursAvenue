= simple_form_for [@user, @participation], html: { id: 'participation-form' } do |f|
  %p
    Renseignez les e-mails de tous les participants, nous leur enverrons en fin de semaine un mail récapitulatif avec toutes les informations importantes pour se rendre à l’atelier :

  .input
    %label.email.control-label> Vous
    %input{ disabled: true, value: @user.email }>
  - (@participation.nb_adults - 1).times do |index|
    .invited_friends-info.input
      %label.email.control-label> Participant #{index + 2}
      %input{ name: "participation[invited_friends][email][]", type: 'email', value: @participation.invited_friends[index].try(:email) }>
      .error{ style: 'display: none;' } Le format de l'email est mauvais

  = f.submit 'Valider', class: 'btn btn--green btn--full', data: { disable_with: 'Validation en cours' }

:javascript
    if($('#participation_nb_adults').length > 0) {
        var $invited_friends_box = $('#invited-friends-box');
        $('#participation_nb_adults').change(function() {
            var nb_adults = this.value;
            if (nb_adults > 1) {
                $invited_friends_box.show();
                $('#invited-friends-box .invited_friends-info').each(function(index, invited_friends_info) {
                    if (index >= nb_adults - 1) { // -1 because we don't need the email of the current_user
                      $(invited_friends_info).hide();
                      $(invited_friends_info).find('input').val('');
                    } else {
                      $(invited_friends_info).show();
                    }
                });
            } else {
                $invited_friends_box.hide();
            }
        });
    }
    $('#participation-form').submit(function() {
        var valid = true
        $('#invited-friends-box .invited_friends-info:visible > input').map(function(index, input) {
            if (input.value.length > 0 && !emailIsValid(input.value)) {
                valid = false;
                $(input).siblings('.error').show();
            } else {
                $(input).siblings('.error').hide();
            }
        })
        return valid;
    });
    function emailIsValid(email) {
        var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email);
    }


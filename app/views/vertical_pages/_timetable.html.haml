%h3 Planning

- (Date.today..7.days.from_now).each do |date|
  - if @city
    - trainings = PlanningSearch.search(visible: true, subject_id: @subject.slug, course_types: ['training'], per_page: 5, start_date: date, lat: @city.latitude, lng: @city.longitude).results
    - courses = PlanningSearch.search(visible: true, subject_id: @subject.slug, course_types: ['lesson'], per_page: 5, week_days: [date.wday], end_date: date, lat: @city.latitude, lng: @city.longitude).results
  - else
    - trainings = PlanningSearch.search(visible: true, subject_id: @subject.slug, course_types: ['training'], per_page: 5, start_date: date).results
    - courses = PlanningSearch.search(visible: true, subject_id: @subject.slug, course_types: ['lesson'], per_page: 5, week_days: [date.wday], end_date: date).results

  - all_courses = (trainings + courses)
  - next if all_courses.empty?
  %h4.push-half--bottom= l(date, format: :semi_long).capitalize
  - all_courses.uniq.sort_by(&:start_time).each do |planning|
    - planning_decorator = planning.decorate
    - structure          = planning.structure
    .flexbox.push-half--bottom.line-height-1-5{ itemscope: true, itemtype: 'http://data-vocabulary.org/Event' }
      .flexbox__item.v-middle
        = image_tag structure.logo.url(:thumb), height: 50, width: 50, class: 'block rounded--circle'
      .flexbox__item.v-middle.one-whole.soft-half--left
        .epsilon.inline-block.v-middle{ itemprop: 'summary' }
          = link_to structure.name, structure_path(planning.structure), class: 'f-weight-600 v-middle'
          %span.v-middle= "- #{planning.course.name.capitalize}"
          %time.v-middle.epsilon.f-weight-600{ itemprop: 'startDate', datetime: planning_decorator.start_date_datetime }
            = planning_decorator.time_slot
        %time{ itemprop: 'endDate', datetime: planning_decorator.end_date_datetime }
        %div{ itemprop: 'location', itemscope: true, itemtype:'http://data-vocabulary.org/Organization' }
          - if planning.place
            %div{ itemprop: 'name' }
              %i.fa.fa-map-marker
              %i= "#{planning.place.address} (#{planning.place.name})"
            %span{ itemprop: 'address', itemscope: true, itemtype: 'http://data-vocabulary.org/Address' }
              %meta{ itemprop: 'street-address', content:planning.place.address }
              %span{ itemprop: 'geo', itemscope: true, itemtype: 'http://data-vocabulary.org/Geo' }
                %meta{ itemprop: 'latitude', content: planning.place.latitude }
                %meta{ itemprop: 'longitude', content: planning.place.longitude }
  %hr.push-half--ends

- if @subject
  - title = "#{@subject.name}"
- else
  - title = "Danse, Théâtre, Musique, Yoga..."

= content_for :title do
  = @vertical_page_decorator.page_title

= content_for :meta_description do
  = "#{@vertical_page_decorator.page_h1} : toutes les écoles de #{@vertical_page.subject_name.downcase}, stages, cours d'essai gratuits, plannings, tarifs, conseils, avis, promotions"

- slug = @subject.root.slug
- if @vertical_page.image.present?
  - bg = asset_path(@vertical_page.image.url(:large))
- else
  - bg = asset_path(subject_image(@subject))

.bg-fixed.bg-cover{ style: "background-image: url('#{bg}')" }
  .main-container.main-container--medium.soft--ends
    %h1.white.soft-black-text-shadow= @vertical_page_decorator.page_h1
    - if @vertical_page.caption
      %h4.center-block.white.soft-black-text-shadow
        = @vertical_page.caption

- content_present = [@vertical_page.content, @subject.good_to_know, @subject.needed_meterial, @subject.tips].reject(&:blank?).any?

.main-container.main-container--medium.soft--ends

  .grid
    .grid__item.six-tenths.palm-one-whole>
      = render partial: 'vertical_pages/breadcrumb'
      -# = render partial: 'vertical_pages/cities'
      - bg_thumb   = @vertical_page.image.url(:thumb)
      - if @subject.root.vertical_pages.any?
        - bg_thumb_2 = @subject.root.vertical_pages.first.image.url(:thumb)
      - else
        - bg_thumb_2 = bg_thumb
      .grid
        .grid__item.one-half.palm-one-whole>
          = link_to search_page_path(@subject.root, @subject, 'paris'), class: 'block muted-link' do
            .relative.text--right.bg-cover.one-whole.height-150{ style: "background-image: url('#{bg_thumb}')" }
              = image_tag 'banners/decouvrir.png', height: 30, class: 'push--bottom absolute south east'
          %h3.delta.line-height-1-7= link_to "Essai gratuits", search_page_path(@subject.root, @subject, 'paris'), class: 'semi-muted-link'
        .grid__item.one-half.palm-one-whole>
          = link_to search_page_path(@subject.root, @subject, 'paris'), class: 'block muted-link' do
            .relative.text--right.bg-cover.one-whole.height-150{ style: "background-image: url('#{bg_thumb_2}')" }
              = image_tag 'banners/decouvrir.png', height: 30, class: 'push--bottom absolute south east'
          %h3.delta.line-height-1-7= link_to "Promotions", search_page_path(@subject.root, @subject, 'paris'), class: 'semi-muted-link'
      %hr
      %h2.flush.delta
        #{StructureSearch.search(lat: 48.8592, lng: 2.3417, subject_id: @subject.slug, per_page: 8).total}
        établissements pour prendre des cours de #{@vertical_page.subject_name}
      .text--right= link_to ">> Voir tous les cours de #{@vertical_page.subject_name}", search_page_path(@subject.root, @subject, 'paris')
      - if (total = PlanningSearch.search({ course_types: 'training', lat: 48.8592, lng: 2.3417, subject_id: @subject.slug }, group: :structure_id_str)).total > 10
        %h2.flush.delta
          Découvrez nos #{total} stages de #{@vertical_page.subject_name}
        .text--right= link_to ">> Voir tous les stages de #{@vertical_page.subject_name}", search_page_path(@subject.root, @subject, 'paris', course_types: ['training'])

      .vertical-page__content.push--top
        - if @vertical_page.content.present?
          %hr.push--top
          %h2
            = @vertical_page.title
          = @vertical_page.content.html_safe
        - else
          - if @subject.good_to_know.present?
            %h3 Bon à savoir / Qu'est-ce que c'est ?
            %p= @subject.good_to_know
          - if @subject.needed_meterial.present?
            %h3 Les bienfaits
            %p= @subject.needed_meterial
          - if @subject.tips.present?
            %h3 Matériel à prévoir
            %p= @subject.tips

      - if @subject.depth == 2
        = render partial: 'vertical_pages/siblings'
      %h3= "Les lieux les plus recherchés"
      .push--bottom
        - @cities.each do |city|
          - next if StructureSearch.search(lat: city.latitude, lng: city.longitude).total < 10
          .inline-block.one-half>
            - if @subject.is_root?
              = link_to "Cours de #{@vertical_page.subject_name} à #{city.name}", root_vertical_page_with_city_path(@vertical_page, city), class: 'epsilon line-height-1-7'
            - else
              = link_to "Cours de #{@vertical_page.subject_name} à #{city.name}", vertical_page_with_city_path(@subject.root, @vertical_page, city), class: 'epsilon line-height-1-7'

    .grid__item.four-tenths.palm-one-whole>
      %h3 #{@vertical_page.subject_name} : sélection
      .bg-white.bordered.soft--ends.soft-half--sides.tab-content
        - structures = StructureSearch.search(order_by: 'is_open_for_trial', subject_id: @vertical_page.subject.slug, per_page: 10).results
        - structures.each_with_index do |structure, index|
          = render partial: 'vertical_pages/structure', locals: { structure: structure }
        .text--center= link_to "Voir tous les cours de #{@vertical_page.subject_name}", search_page_path(@subject.root, @subject, 'paris'), class: 'epsilon'


- if @subject.depth == 0
  .home-screen-promotion-wrapper
    .main-container.main-container--medium.soft--ends
      %h2.soft--bottom.f-weight-300 #{@subject.name} : plus de disciplines
      - cache [@subject, 'vertical_pages/subjects/depth_1'] do
        = render partial: 'vertical_pages/subjects', locals: { subjects: @subject.children.includes(:vertical_pages) }

- unless @subject.depth == 2
  .soft--ends{ class: (@subject.depth == 0 ? '' : 'home-screen-promotion-wrapper') }
    .main-container.main-container--medium
      %h2.soft--bottom.f-weight-300 #{@subject.name} : tous les styles
      - cache [@subject, 'vertical_pages/subjects/depth_2'] do
        = render partial: 'vertical_pages/subjects', locals: { subjects: @subject.descendants.at_depth(2).includes(:vertical_pages) }

%div{ class: (@subject.depth == 0 || @subject.depth == 2 ? 'home-screen-promotion-wrapper' : '') }
  .main-container.main-container--medium.soft--ends
    %h2.soft--bottom.f-weight-300 #{@vertical_page.title} : sélection d'avis
    = render partial: 'vertical_pages/comments', locals: { comments: @vertical_page.reviews }
